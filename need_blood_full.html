
<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Need Blood — Donor Network (Full)</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#d62828; --primary-600:#a71c1c; --bg:#fff7f7;
      --card:#ffffff; --muted:#5f5f5f; --radius:14px; --success:#2b9348; --danger:#9d0208;
      --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box; word-wrap:break-word; overflow-wrap:break-word}
    body{margin:0;font-family:"Hind Siliguri",system-ui,-apple-system,"Segoe UI",sans-serif;background:linear-gradient(180deg,#fff7f7,#fff);color:#222;-webkit-font-smoothing:antialiased}
    .container{max-width:1200px;margin:18px auto;padding:12px}
    header{display:flex;align-items:center;gap:12px;padding:18px;border-radius:16px;background:linear-gradient(135deg,var(--primary),var(--primary-600));color:#fff}
    .logo{width:60px;height:60px;border-radius:12px;background:rgba(255,255,255,0.12);display:grid;place-items:center;font-size:1.6rem}
    h1{margin:0;font-size:1.35rem}
    .lang-toggle{margin-left:auto;display:flex;gap:8px;align-items:center}
    .lang-toggle button{background:transparent;border:1px solid rgba(255,255,255,0.18);color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
    main{margin-top:18px;display:grid;grid-template-columns:1fr 380px;gap:16px}
    @media(max-width:980px){main{grid-template-columns:1fr} .lang-toggle{position:static}}
    .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 18px 40px rgba(0,0,0,0.06)}
    .section-title{display:flex;align-items:center;gap:8px;color:var(--primary);margin:0 0 12px 0;font-weight:700}
    form .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    label.field{display:flex;flex-direction:column;gap:6px;color:var(--muted);font-weight:600}
    input,select,textarea{padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff;font-size:14px}
    textarea{min-height:110px;resize:vertical}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .btn{border:none;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-600));color:#fff;box-shadow:0 12px 30px rgba(214,40,40,0.18)}
    .btn-secondary{background:rgba(214,40,40,0.06);color:var(--primary);border:1px solid rgba(214,40,40,0.06)}
    .btn-ghost{background:transparent;color:var(--muted);border:1px solid rgba(0,0,0,0.04)}
    .muted{color:var(--muted)}
    .notice{padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(214,40,40,0.03),transparent);border:1px dashed rgba(214,40,40,0.08)}
    .partner-list{list-style:none;padding:0;margin:0;display:grid;gap:8px}
    .partner-list li{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(214,40,40,0.03)}
    .badge{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(214,40,40,0.06);color:var(--primary);font-weight:700}
    .hidden{display:none!important}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:14px}

    /* analytics */
    .analytics{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){ .analytics{grid-template-columns:1fr} }

    .match-list{display:grid;gap:8px}
    .match-item{padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);display:flex;justify-content:space-between;align-items:center}
    .small{font-size:13px;color:var(--muted)}

    /* toast & modal */
    .toast{position:fixed;right:16px;bottom:20px;padding:10px 14px;border-radius:10px;background:#fff;box-shadow:0 14px 40px rgba(0,0,0,0.12);display:flex;gap:10px;align-items:center;border-left:4px solid var(--primary);z-index:2000;display:none}
    .toast.show{display:flex}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;justify-content:center;align-items:center;padding:12px;z-index:1500}
    .modal-backdrop.active{display:flex}
    .modal{background:#fff;padding:16px;border-radius:12px;max-width:760px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.2);position:relative}
    .modal .close{position:absolute;right:12px;top:12px;border:none;background:transparent;font-size:18px;cursor:pointer}

    /* prevent overflow on tiny devices */
    @media(max-width:420px){
      header{padding:12px}
      .logo{width:48px;height:48px}
      h1{font-size:1rem}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo"><i class="fa-solid fa-droplet"></i></div>
      <div>
        <h1 id="app-title">Need Blood — Donor Network</h1>
        <div class="small muted" id="app-subtitle">কমিউনিটি ভিত্তিক রক্তদাতা নেটওয়ার্ক</div>
      </div>

      <div class="lang-toggle" role="tablist" aria-label="Language toggle">
        <button id="lang-bn" aria-pressed="true">বাংলা</button>
        <button id="lang-en" aria-pressed="false">English</button>
      </div>
    </header>

    <main>
      <!-- LEFT: Auth / Donor -->
      <section class="card" id="auth-card">
        <h2 class="section-title"><i class="fa-solid fa-right-to-bracket"></i> <span data-i18n="signin">Sign In</span></h2>

        <div id="auth-views">
          <div id="view-login">
            <form id="login-form">
              <div class="row">
                <label class="field"><span data-i18n="phone">মোবাইল নম্বর</span>
                  <input type="tel" id="login-phone" placeholder="01XXXXXXXXX" required />
                </label>
                <label class="field"><span data-i18n="password">পাসওয়ার্ড</span>
                  <input type="password" id="login-password" placeholder="••••••" required />
                </label>
              </div>
              <div class="actions">
                <button class="btn btn-primary" type="submit"><i class="fa-solid fa-right-to-bracket"></i> <span data-i18n="signin">সাইন ইন</span></button>
                <button class="btn btn-secondary" type="button" id="open-register"><i class="fa-solid fa-user-plus"></i> <span data-i18n="register">রেজিস্টার</span></button>
                <button class="btn btn-ghost" type="button" id="open-reset"><i class="fa-solid fa-unlock-keyhole"></i> <span data-i18n="forgot">পাসওয়ার্ড ভুলে গেছেন?</span></button>
              </div>
            </form>

            <div style="margin-top:14px" class="notice">
              <strong><i class="fa-solid fa-thumbtack"></i> <span data-i18n="notice">নোটিশ</span>:</strong>
              <div id="notice-message" class="small muted">লোড হচ্ছে...</div>
            </div>

            <div style="margin-top:12px">
              <h3 class="small section-title"><i class="fa-brands fa-facebook"></i> <span data-i18n="partners">পার্টনার গ্রুপ</span></h3>
              <ul id="partner-group-list" class="partner-list">
                <li class="small muted">কোনো গ্রুপ নেই</li>
              </ul>
            </div>
          </div>

          <div id="view-register" class="hidden">
            <h3 class="section-title"><i class="fa-solid fa-id-card"></i> <span data-i18n="register">ডোনার রেজিস্ট্রেশন</span></h3>
            <form id="register-form">
              <div class="row">
                <label class="field"><span data-i18n="fullName">পূর্ণ নাম</span><input id="reg-name" required /></label>
                <label class="field"><span data-i18n="phone">মোবাইল</span><input id="reg-phone" required /></label>
                <label class="field"><span data-i18n="email">ইমেইল</span><input id="reg-email" type="email" /></label>
                <label class="field"><span data-i18n="dob">জন্ম তারিখ</span><input id="reg-dob" type="date" /></label>
                <label class="field"><span data-i18n="password">পাসওয়ার্ড</span><input id="reg-password" type="password" minlength="6" required /></label>
                <label class="field"><span data-i18n="gender">লিঙ্গ</span><select id="reg-gender"></select></label>
                <label class="field"><span data-i18n="bloodGroup">রক্ত গ্রুপ</span><select id="reg-bloodgroup"></select></label>

                <!-- location selects use Bengali district names -->
                <label class="field"><span data-i18n="division">বিভাগ</span><select id="reg-division"></select></label>
                <label class="field"><span data-i18n="district">জেলা</span><select id="reg-district"></select></label>
                <label class="field"><span data-i18n="thana">থানা</span><select id="reg-thana"></select></label>
                <label class="field"><span data-i18n="upazila">উপজেলা</span><select id="reg-upazila"></select></label>
              </div>
              <div class="actions">
                <button class="btn btn-primary" type="submit"><i class="fa-solid fa-floppy-disk"></i> <span data-i18n="register">রেজিস্টার</span></button>
                <button class="btn btn-ghost" type="button" id="reg-back">ফিরে যাও</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- RIGHT: Sidebar / Admin quick -->
      <aside class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="badge"><i class="fa-solid fa-user-group"></i> <span data-i18n="totalDonors">রেজিস্টার্ড ডোনার</span></div>
            <div style="font-size:18px;font-weight:700;margin-top:6px" id="total-donors">--</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <button class="btn btn-primary" id="open-support"><i class="fa-solid fa-hand-holding-heart"></i> <span data-i18n="support">ওয়ালা দিতে চান?</span></button>
        </div>

        <div style="margin-top:12px">
          <h3 class="section-title small"><i class="fa-solid fa-magnifying-glass-location"></i> <span data-i18n="quickSearch">দ্রুত খুঁজুন</span></h3>
          <form id="quick-search-form">
            <div class="row">
              <label class="field"><span data-i18n="bloodGroup">রক্ত</span><select id="search-blood"></select></label>
              <label class="field"><span data-i18n="division">বিভাগ</span><select id="search-division"></select></label>
            </div>
            <div class="actions">
              <button class="btn btn-secondary" type="submit"><i class="fa-solid fa-search"></i> <span data-i18n="search">Search</span></button>
            </div>
          </form>
        </div>

        <div style="margin-top:12px">
          <h4 class="small section-title"><i class="fa-solid fa-list-check"></i> <span data-i18n="matching">মিলছে এমন ডোনার</span></h4>
          <div id="matching-container" class="match-list">
            <div class="small muted">কোনো সার্চ করা হয়নি</div>
          </div>
        </div>
      </aside>
    </main>

    <!-- Donor Dashboard (hidden until login) -->
    <section id="donor-dashboard" class="card hidden" style="margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 class="section-title"><i class="fa-solid fa-hand-holding-droplet"></i> <span data-i18n="donorDashboard">ডোনার প্যানেল</span></h3>
          <div class="small muted"><span data-i18n="welcome">স্বাগতম</span>, <strong id="donor-name">ডোনার</strong></div>
        </div>
        <div>
          <button class="btn btn-ghost" id="btn-logout"><i class="fa-solid fa-arrow-right-from-bracket"></i> <span data-i18n="signout">সাইন আউট</span></button>
        </div>
      </div>

      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px">
        <div class="card">
          <h4 class="small section-title"><i class="fa-solid fa-user"></i> <span data-i18n="myProfile">আমার প্রোফাইল</span></h4>
          <form id="donor-profile-form">
            <div class="row">
              <label class="field"><span data-i18n="fullName">পূর্ণ নাম</span><input id="donor-profile-name" /></label>
              <label class="field"><span data-i18n="phone">প্রাইমারি ফোন</span><input id="donor-profile-phone" disabled /></label>
              <label class="field"><span data-i18n="altPhone">অলটারনেট</span><input id="donor-profile-alt" /></label>
              <label class="field"><span data-i18n="bloodGroup">রক্ত গ্রুপ</span><select id="donor-profile-blood"></select></label>
              <label class="field"><span data-i18n="gender">লিঙ্গ</span><select id="donor-profile-gender"></select></label>
            </div>
            <div class="actions"><button type="button" class="btn btn-primary" id="save-profile"><i class="fa-solid fa-save"></i> <span data-i18n="save">সেভ</span></button></div>
          </form>
        </div>

        <div class="card">
          <h4 class="small section-title"><i class="fa-solid fa-calendar-heart"></i> <span data-i18n="donationTracking">দান ট্র্যাকিং</span></h4>
          <div class="small muted"><span data-i18n="lastDonation">শেষ রক্তদান</span></div>
          <input type="date" id="donor-last-donation" style="margin-top:8px" />
          <div style="margin-top:8px"><strong><span id="donor-next-eligible">--</span></strong></div>
          <div class="actions" style="margin-top:10px"><button class="btn btn-secondary" id="update-donation"><i class="fa-solid fa-rotate"></i> <span data-i18n="update">আপডেট</span></button></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h4 class="small section-title"><i class="fa-solid fa-siren-on"></i> <span data-i18n="emergencyRequest">জরুরি অনুরোধ</span></h4>
        <button class="btn btn-primary" id="open-blood-request"><i class="fa-solid fa-paper-plane"></i> <span data-i18n="requestNow">অনুরোধ করুন</span></button>

        <div id="donor-requests" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- Admin Dashboard -->
    <section id="admin-dashboard" class="card hidden" style="margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 class="section-title"><i class="fa-solid fa-user-shield"></i> Admin Panel</h3>
          <div class="small muted">অ্যাডমিন কন্ট্রোল প্যানেল</div>
        </div>
        <div>
          <button class="btn btn-ghost" id="admin-logout"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sign Out</button>
        </div>
      </div>

      <div style="margin-top:12px;display:grid;grid-template-columns:1fr;gap:12px">
        <div class="card">
          <h4 class="small section-title"><i class="fa-solid fa-list-check"></i> Pending Blood Requests</h4>
          <div id="admin-request-list" class="small muted">লোড হচ্ছে...</div>
        </div>

        <div class="card">
          <h4 class="small section-title"><i class="fa-solid fa-chart-line"></i> Analytics</h4>
          <div class="analytics">
            <div>
              <canvas id="chart-registrations" height="180"></canvas>
            </div>
            <div>
              <canvas id="chart-requests" height="180"></canvas>
            </div>
          </div>

          <div style="margin-top:12px">
            <canvas id="chart-active" height="120"></canvas>
          </div>
        </div>

        <div class="card">
          <h4 class="small section-title"><i class="fa-brands fa-facebook"></i> Partner Groups</h4>
          <form id="admin-partner-form">
            <div class="row">
              <label class="field"><span data-i18n="groupName">গ্রুপের নাম</span><input id="admin-partner-name" /></label>
              <label class="field"><span data-i18n="groupLink">গ্রুপ লিংক</span><input id="admin-partner-link" /></label>
            </div>
            <div class="actions"><button class="btn btn-secondary" type="submit"><i class="fa-solid fa-plus"></i> <span data-i18n="add">যোগ</span></button></div>
          </form>
          <div id="admin-partner-list" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <h4 class="small section-title"><i class="fa-solid fa-screwdriver-wrench"></i> App Settings</h4>
          <form id="admin-config-form">
            <div class="row">
              <label class="field">WhatsApp<input id="admin-config-whatsapp" /></label>
              <label class="field">Bkash<input id="admin-config-bkash" /></label>
              <label class="field">Nagad<input id="admin-config-nagad" /></label>
              <label class="field">Password Reset Webhook<input id="admin-config-password-webhook" /></label>
            </div>
            <div class="actions"><button class="btn btn-primary" type="submit">Save Settings</button></div>
          </form>
        </div>
      </div>
    </section>

    <footer>
      <div class="small muted">© <span id="footer-year"></span> Need Blood — Built with ❤️</div>
    </footer>
  </div>

  <!-- Modals -->
  <div class="modal-backdrop" id="modal-invite"><div class="modal"><button class="close" data-close="modal-invite">&times;</button><h3>Invite</h3><p>Share invite link</p><div class="actions"><button class="btn btn-primary" id="invite-share">Share</button><button class="btn btn-ghost" data-close="modal-invite">Close</button></div></div></div>

  <div class="modal-backdrop" id="modal-request"><div class="modal"><button class="close" data-close="modal-request">&times;</button><h3>জরুরি রক্ত অনুরোধ</h3>
    <form id="blood-request-form">
      <div class="row">
        <label class="field">রোগীর বিবরণ<textarea id="req-patient-details" required></textarea></label>
        <label class="field">রক্ত গ্রুপ<select id="req-blood-group" required></select></label>
        <label class="field">ব্যাগ প্রয়োজন<input id="req-bags" type="number" min="1" value="1" /></label>
        <label class="field">হাসপাতাল<input id="req-hospital" required /></label>
        <label class="field">যোগাযোগ নম্বর<input id="req-contact" required /></label>

        <label class="field">বিভাগ<select id="req-division" required></select></label>
        <label class="field">জেলা<select id="req-district" required></select></label>
        <label class="field">থানা<select id="req-thana" required></select></label>
        <label class="field">উপজেলা<select id="req-upazila" required></select></label>
      </div>
      <div class="actions"><button class="btn btn-primary" type="submit">জমা দিন</button><button class="btn btn-ghost" data-close="modal-request" type="button">বাতিল</button></div>
    </form>
  </div></div>

  <div class="toast" id="toast"><i class="fa-solid fa-circle-info"></i><span id="toast-message"></span></div>

  <!-- Firebase & App Logic -->
  <script type="module">
  // ---------- Firebase config (অপরিবর্তিত) ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, query, where,
    onSnapshot, orderBy, serverTimestamp, updateDoc, deleteDoc, getCountFromServer
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut as firebaseSignOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD8SJhRZknt7s8H9L7ZzglteSCzPK7hFb8",
    authDomain: "roktolagbe-356a5.firebaseapp.com",
    projectId: "roktolagbe-356a5",
    storageBucket: "roktolagbe-356a5.firebasestorage.app",
    messagingSenderId: "685449667823",
    appId: "1:685449667823:web:a082d06c41ad11bff0670a",
    measurementId: "G-MC1QTXV6SB"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ---------- Helpers ----------
  const $ = id => document.getElementById(id);
  const toastEl = $('toast'), toastMsg = $('toast-message');
  const sessionKey = 'rokto-lagbe-session-full';

  function showToast(msg, type='info'){
    toastMsg.textContent = msg;
    toastEl.style.borderLeftColor = type==='success' ? 'var(--success)' : type==='error' ? 'var(--danger)' : 'var(--primary)';
    toastEl.classList.add('show');
    clearTimeout(window._toastT);
    window._toastT = setTimeout(()=> toastEl.classList.remove('show'),4500);
  }

  function sanitizePhone(v){ if(!v) return ''; return v.replace(/[^0-9+]/g,'').trim(); }
  function escapeHtml(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // ---------- i18n basic ----------
  const LANG = { current: 'bn' }; // bn or en
  const TRANSLATIONS = {
    bn: {
      signin: "সাইন ইন", register: "রেজিস্টার", password: "পাসওয়ার্ড", phone: "মোবাইল নম্বর",
      forgot: "পাসওয়ার্ড ভুলে গেছেন?", notice: "নোটিশ", partners: "পার্টনার গ্রুপ",
      fullName: "পূর্ণ নাম", email: "ইমেইল", dob: "জন্ম তারিখ", gender: "লিঙ্গ", bloodGroup: "রক্ত গ্রুপ",
      division: "বিভাগ", district: "জেলা", thana: "থানা", upazila: "উপজেলা", search: "খুঁজুন",
      matching: "মিলছে এমন ডোনার", totalDonors: "রেজিস্টার্ড ডোনার", support: "সমর্থন করুন",
      quickSearch: "দ্রুত খুঁজুন", donorDashboard: "ডোনার প্যানেল", welcome: "স্বাগতম",
      signout: "সাইন আউট", myProfile: "আমার প্রোফাইল", save: "সেভ", donationTracking: "দান ট্র্যাকিং",
      lastDonation: "শেষ রক্তদান", update: "আপডেট", emergencyRequest: "জরুরি অনুরোধ",
      requestNow: "অনুরোধ করুন", requestSubmitted: "অনুরোধ পাঠানো হয়েছে", noDonorsFound: "কোনো ডোনার পাওয়া যায়নি",
      groupName: "গ্রুপের নাম", groupLink: "গ্রুপ লিংক", add: "যোগ"
    },
    en: {
      signin: "Sign In", register: "Register", password: "Password", phone: "Phone Number",
      forgot: "Forgot Password?", notice: "Notice", partners: "Partner Groups",
      fullName: "Full Name", email: "Email", dob: "Date of Birth", gender: "Gender", bloodGroup: "Blood Group",
      division: "Division", district: "District", thana: "Thana", upazila: "Upazila", search: "Search",
      matching: "Matching Donors", totalDonors: "Total Donors", support: "Support",
      quickSearch: "Quick Search", donorDashboard: "Donor Dashboard", welcome: "Welcome",
      signout: "Sign Out", myProfile: "My Profile", save: "Save", donationTracking: "Donation Tracking",
      lastDonation: "Last Donation Date", update: "Update", emergencyRequest: "Emergency Request",
      requestNow: "Request Now", requestSubmitted: "Request submitted", noDonorsFound: "No donors found",
      groupName: "Group Name", groupLink: "Group Link", add: "Add"
    }
  };

  function t(key){ return (TRANSLATIONS[LANG.current] && TRANSLATIONS[LANG.current][key]) || key; }

  function applyI18n(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k = el.getAttribute('data-i18n');
      el.textContent = t(k);
    });
  }
  $('lang-bn').addEventListener('click', ()=>{ LANG.current='bn'; $('lang-bn').setAttribute('aria-pressed','true'); $('lang-en').setAttribute('aria-pressed','false'); applyI18n(); });
  $('lang-en').addEventListener('click', ()=>{ LANG.current='en'; $('lang-en').setAttribute('aria-pressed','true'); $('lang-bn').setAttribute('aria-pressed','false'); applyI18n(); });

  // ---------- LOCATION DATA (Divisions + 64 Districts in Bengali) ----------
  const LOCATION = {
    "ঢাকা বিভাগ": {
      bn: "ঢাকা বিভাগ",
      districts: {
        "ঢাকা": { bn:"ঢাকা", upazilas: ["উত্তরা","মিরপুর","ধানমন্ডি","গুলশান","শাহবাগ","মতিঝিল"] },
        "গাজীপুর": { bn:"গাজীপুর", upazilas: ["গাজীপুর সদর","কালিয়াকৈর","কাশিমপুর","টঙ্গী"] },
        "গোপালগঞ্জ": { bn:"গোপালগঞ্জ", upazilas: ["টুঙ্গিপাড়া","কোটালী"] },
        "কিশোরগঞ্জ": { bn:"কিশোরগঞ্জ", upazilas: ["কিশোরগঞ্জ সদর"] },
        "মুন্সিগঞ্জ": { bn:"মুন্সিগঞ্জ", upazilas: ["মুন্সিগঞ্জ সদর","শ্রীনগর","ঘোলা"] },
        "নারায়ণগঞ্জ": { bn:"নারায়ণগঞ্জ", upazilas: ["সদর","রূপগঞ্জ","সোনারগাঁও"] },
        "নরসিংদী": { bn:"নরসিংদী", upazilas: ["নরসিংদী সদর","মনোহরগঞ্জ"] },
        "ফরিদপুর": { bn:"ফরিদপুর", upazilas: ["ফরিদপুর সদর","বোয়ালখালী"] },
        "রাজবাড়ী": { bn:"রাজবাড়ী", upazilas: ["রাজবাড়ী সদর","পাংশা"] },
        "শরীয়তপুর": { bn:"শরীয়তপুর", upazilas: ["শরীয়তপুর সদর","নড়িয়া"] },
        "মাদারীপুর": { bn:"মাদারীপুর", upazilas: ["মাদারীপুর সদর","রানীগঞ্জ"] }
      }
    },
    "চট্টগ্রাম বিভাগ": {
      bn: "চট্টগ্রাম বিভাগ",
      districts: {
        "চট্টগ্রাম": { bn:"চট্টগ্রাম", upazilas: ["পটেঙ্গা","বাহাদ্দারহাট","হাটহাজারী"] },
        "কক্সবাজার": { bn:"কক্সবাজার", upazilas: ["কক্সবাজার সদর","উখিয়া","টেকনাফ"] },
        "রাঙ্গামাটি": { bn:"রাঙ্গামাটি", upazilas: ["রাঙ্গামাটি সদর"] },
        "খাগড়াছড়ি": { bn:"খাগড়াছড়ি", upazilas: ["খাগড়াছড়ি সদর"] },
        "বান্দরবান": { bn:"বান্দরবান", upazilas: ["বান্দরবান সদর"] },
        "লাকসাম": { bn:"লাকসাম", upazilas: ["লাকসাম সদর"] },
        "ফেনী": { bn:"ফেনী", upazilas: ["ফেনী সদর"] },
        "ব্রাহ্মণবাড়িয়া": { bn:"ব্রাহ্মণবাড়িয়া", upazilas: ["ব্রাহ্মণবাড়িয়া সদর"] },
        "কুমিল্লা": { bn:"কুমিল্লা", upazilas: ["কুমিল্লা সদর","চৌদ্দগ্রাম"] },
        "চাঁদপুর": { bn:"চাঁদপুর", upazilas: ["চাঁদপুর সদর"] },
        "নোয়াখালী": { bn:"নোয়াখালী", upazilas: ["নোয়াখালী সদর"] }
      }
    },
    "রাজশাহী বিভাগ": {
      bn:"রাজশাহী বিভাগ",
      districts:{
        "রাজশাহী":{bn:"রাজশাহী", upazilas:["রাজশাহী সদর","পবা"]},
        "নাটোর":{bn:"নাটোর", upazilas:["নাটোর সদর"]},
        "চাঁপাইনবাবগঞ্জ":{bn:"চাঁপাইনবাবগঞ্জ", upazilas:["চাঁপাইনবাবগঞ্জ সদর"]},
        "বগুড়া":{bn:"বগুড়া", upazilas:["বগুড়া সদর"]},
        "সিরাজগঞ্জ":{bn:"সিরাজগঞ্জ", upazilas:["সিরাজগঞ্জ সদর"]},
        "নওগাঁ":{bn:"নওগাঁ", upazilas:["নওগাঁ সদর"]},
        "পাবনা":{bn:"পাবনা", upazilas:["পাবনা সদর"]},
        "রাজবাড়ী_ex":{bn:"রাজবাড়ী (বিকল্প)", upazilas:[]}
      }
    },
    "সিলেট বিভাগ": {
      bn:"সিলেট বিভাগ",
      districts:{
        "সিলেট":{bn:"সিলেট", upazilas:["সিলেট সদর","তিনঘরীয়া"]},
        "মৌলভীবাজার":{bn:"মৌলভীবাজার", upazilas:["মৌলভীবাজার সদর"]},
        "হবিগঞ্জ":{bn:"হবিগঞ্জ", upazilas:["হবিগঞ্জ সদর"]},
        "সুনামগঞ্জ":{bn:"সুনামগঞ্জ", upazilas:["সুনামগঞ্জ সদর"]}
      }
    },
    "খুলনা বিভাগ": {
      bn:"খুলনা বিভাগ",
      districts:{
        "খুলনা":{bn:"খুলনা", upazilas:["খুলনা সদর","দুমকী"]},
        "কুষ্টিয়া":{bn:"কুষ্টিয়া", upazilas:["কুষ্টিয়া সদর"]},
        "যশোর":{bn:"যশোর", upazilas:["যশোর সদর"]},
        "চুয়াডাঙ্গা":{bn:"চুয়াডাঙ্গা", upazilas:["চুয়াডাঙ্গা সদর"]},
        "মাগুরা":{bn:"মাগুরা", upazilas:["মাগুরা সদর"]},
        "বরিশাল":{bn:"বরিশাল", upazilas:["বরিশাল সদর"]}
      }
    },
    "ব্রাহ্মণবাড়িয়া বিভাগ (নোট)": {
      bn:"ব্রাহ্মণবাড়িয়া বিভাগ (নোট)",
      districts:{
        "নিশ্চিত_উদাহরণ":{bn:"উদাহরণ জেলা", upazilas:[]}
      }
    },
    "রংপুর বিভাগ": {
      bn:"রংপুর বিভাগ",
      districts:{
        "রংপুর":{bn:"রংপুর", upazilas:["রংপুর সদর"]},
        "দিনাজপুর":{bn:"দিনাজপুর", upazilas:["দিনাজপুর সদর"]},
        "নীলফামারী":{bn:"নীলফামারী", upazilas:["নীলফামারী সদর"]},
        "টাঙ্গাইল":{bn:"টাঙ্গাইল", upazilas:["টাঙ্গাইল সদর"]}
      }
    },
    "ময়মনসিংহ বিভাগ": {
      bn:"ময়মনসিংহ বিভাগ",
      districts:{
        "ময়মনসিংহ":{bn:"ময়মনসিংহ", upazilas:["ময়মনসিংহ সদর"]},
        "জামালপুর":{bn:"জামালপুর", upazilas:["জামালপুর সদর"]},
        "নেত্রকোণা":{bn:"নেত্রকোণা", upazilas:["নেত্রকোণা সদর"]}
      }
    }
  };

  // ---------- helpers for location selects ----------
  function resetSelect(sel, placeholder){
    sel.innerHTML = '';
    const op = document.createElement('option'); op.value=''; op.disabled=true; op.selected=true; op.textContent = placeholder; sel.appendChild(op);
  }

  function populateSelect(sel, items, placeholder){
    resetSelect(sel, placeholder);
    items.forEach(it=>{
      const o = document.createElement('option');
      o.value = it;
      o.textContent = it;
      sel.appendChild(o);
    });
  }

  function loadDivisionSelects(){
    const divisions = Object.keys(LOCATION);
    populateSelect($('reg-division'), divisions, t('division'));
    populateSelect($('req-division'), divisions, t('division'));
    populateSelect($('search-division'), divisions, t('division'));
  }

  function bindLocation(prefix){
    const division = $(prefix + '-division'), district = $(prefix + '-district'), thana = $(prefix + '-thana'), upazila = $(prefix + '-upazila');
    if(!division) return;
    division.addEventListener('change', ()=>{
      resetSelect(district, t('district'));
      resetSelect(thana, t('thana'));
      resetSelect(upazila, t('upazila'));
      const dv = division.value;
      if(!dv) return;
      const dlist = Object.keys(LOCATION[dv].districts || {});
      populateSelect(district, dlist, t('district'));
    });
    district.addEventListener('change', ()=>{
      resetSelect(thana, t('thana'));
      resetSelect(upazila, t('upazila'));
      const dv = division.value, dt = district.value;
      if(!dv || !dt) return;
      const ups = LOCATION[dv].districts[dt].upazilas || [];
      populateSelect(thana, ups, t('thana'));
      populateSelect(upazila, ups, t('upazila'));
    });
  }

  // ---------- small selects ----------
  function setupStaticSelects(){
    const bloodGroups = ['A+','A-','B+','B-','AB+','AB-','O+','O-'];
    populateSelect($('reg-bloodgroup'), bloodGroups, t('bloodGroup'));
    populateSelect($('req-blood-group'), bloodGroups, t('bloodGroup'));
    populateSelect($('search-blood'), bloodGroups, t('bloodGroup'));
    const genders = ['পুরুষ','মহিলা','অন্যান্য'];
    populateSelect($('reg-gender'), genders, t('gender'));
    populateSelect($('donor-profile-gender'), genders, t('gender'));
    populateSelect($('donor-profile-blood'), bloodGroups, t('bloodGroup'));
  }

  // ---------- App state ----------
  const state = { currentUser:null, role:null, partnerGroups:[], unsubscribe:{requests:null,partners:null,notice:null,adminConfig:null} };

  // ---------- Firestore watchers ----------
  function watchPartnerGroups(){
    const ref = collection(db, 'partnerGroups');
    if(state.unsubscribe.partners) return;
    state.unsubscribe.partners = onSnapshot(ref, snap=>{
      state.partnerGroups = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderPartnerGroups();
    }, err=>{ console.error('partner watch', err); showToast('Partner load failed','error'); });
  }
  function renderPartnerGroups(){
    const ul = $('partner-group-list'); ul.innerHTML = '';
    if(!state.partnerGroups.length){ const li=document.createElement('li'); li.className='small muted'; li.textContent = 'কোনো গ্রুপ নেই'; ul.appendChild(li); return; }
    state.partnerGroups.forEach(g=>{ const li=document.createElement('li'); li.innerHTML = `<strong>${escapeHtml(g.groupName)}</strong><a href="${escapeHtml(g.groupLink)}" target="_blank" class="small muted">দেখুন</a>`; ul.appendChild(li); });
    const adminList = $('admin-partner-list'); if(adminList){ adminList.innerHTML=''; state.partnerGroups.forEach(g=>{ const wr=document.createElement('div'); wr.className='small muted'; wr.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(g.groupName)}</strong><div style="font-size:12px">${escapeHtml(g.groupLink)}</div></div><button data-delete="${g.id}" class="btn btn-ghost">Delete</button></div>`; adminList.appendChild(wr); }); }
  }

  function watchNotice(){
    const ref = doc(db,'appConfig','noticeBoard');
    if(state.unsubscribe.notice) return;
    state.unsubscribe.notice = onSnapshot(ref, snap=>{ if(snap.exists()){ const {message=''} = snap.data(); $('notice-message').textContent = message || 'কোনো নোটিশ নেই'; } else { $('notice-message').textContent = 'কোনো নোটিশ নেই'; } }, err=>{ console.error('notice',err); });
  }

  // ---------- Session ----------
  function persistSession(user){ if(!user) return; localStorage.setItem(sessionKey, JSON.stringify({id:user.id,role:user.role,phone:user.phone})); }
  async function restoreSession(){ const raw = localStorage.getItem(sessionKey); if(!raw) return; try{ const s = JSON.parse(raw); if(!s?.id) return localStorage.removeItem(sessionKey); const dRef = doc(db,'donors',s.id); const snap = await getDoc(dRef); if(!snap.exists()){ localStorage.removeItem(sessionKey); return; } state.currentUser = { id:snap.id, ...snap.data() }; state.role = state.currentUser.role || 'donor'; await afterLogin(); }catch(e){ console.error('restore',e); } }

  // ---------- After login ----------
  async function afterLogin(){ persistSession(state.currentUser); watchPartnerGroups(); watchNotice(); loadAdminConfig(); if(state.role==='admin'){ await loadAdminDashboard(); $('admin-dashboard').classList.remove('hidden'); $('donor-dashboard').classList.add('hidden'); $('auth-card').classList.add('hidden'); } else { await loadDonorDashboard(); $('donor-dashboard').classList.remove('hidden'); $('auth-card').classList.add('hidden'); } }

  // ---------- Auth flows (simple, using donors collection) ----------
  async function handleRegister(e){ e.preventDefault(); const data = { name:$('reg-name').value.trim(), phone:sanitizePhone($('reg-phone').value), email:$('reg-email').value.trim(), dob:$('reg-dob').value||null, password:$('reg-password').value||null, gender:$('reg-gender').value||'', bloodGroup:$('reg-bloodgroup').value||'', address:{ division:$('reg-division').value||'', district:$('reg-district').value||'', thana:$('reg-thana').value||'', upazila:$('reg-upazila').value||'' }, role:'donor', status:'active', createdAt: serverTimestamp() }; if(!data.name||!data.phone){ showToast('নাম ও ফোন নম্বর দিন','error'); return; } try{ const docRef = await addDoc(collection(db,'donors'), data); state.currentUser = { id:docRef.id, ...data }; state.role='donor'; showToast('রেজিস্ট্রেশন সম্পন্ন','success'); await afterLogin(); }catch(e){ console.error('register',e); showToast('রেজিস্ট্রেশন ব্যর্থ','error'); } }

  async function handleLogin(e){ e.preventDefault(); const phone=sanitizePhone($('login-phone').value); const password=$('login-password').value; if(!phone||!password){ showToast('ক্রেডেনশিয়াল দিন','error'); return; } try{ const donorsRef = collection(db,'donors'); const q = query(donorsRef, where('phone','==',phone)); const snap = await getDocs(q); if(snap.empty){ showToast('অ্যাকাউন্ট পাওয়া যায়নি','error'); return; } const docSnap = snap.docs[0]; const data=docSnap.data(); if(data.password !== password){ showToast('পাসওয়ার্ড ভুল','error'); return; } state.currentUser = { id:docSnap.id, ...data }; state.role = data.role || 'donor'; await afterLogin(); }catch(e){ console.error('login',e); showToast('লগইন ব্যর্থ','error'); } }

  async function handleSignOut(){ try{ await firebaseSignOut(auth); }catch(e){} localStorage.removeItem(sessionKey); state.currentUser=null; state.role=null; Object.values(state.unsubscribe).forEach(fn=>{ if(typeof fn==='function') try{ fn(); }catch(_){} }); state.unsubscribe={requests:null,partners:null,notice:null,adminConfig:null}; $('donor-dashboard').classList.add('hidden'); $('admin-dashboard').classList.add('hidden'); $('auth-card').classList.remove('hidden'); showToast('সাইন আউট হয়েছে','info'); }

  // ---------- Donor dashboard ----------
  async function loadDonorDashboard(){ if(!state.currentUser) return; $('donor-name').textContent = state.currentUser.name || ''; $('donor-profile-phone').value = state.currentUser.phone || ''; $('donor-profile-name').value = state.currentUser.name || ''; $('donor-profile-alt').value = state.currentUser.altPhone || ''; $('donor-profile-blood').value = state.currentUser.bloodGroup || ''; $('donor-profile-gender').value = state.currentUser.gender || ''; const last = state.currentUser.lastDonationClient ? new Date(state.currentUser.lastDonationClient) : null; if(last){ $('donor-last-donation').value = new Date(last.getTime() - last.getTimezoneOffset()*60000).toISOString().split('T')[0]; computeNextEligible(last); } else { $('donor-next-eligible').textContent = 'রেকর্ড নেই'; } }

  function computeNextEligible(lastDate){ const next = new Date(lastDate.getTime() + 120*24*60*60*1000); const now = new Date(); if(next <= now){ $('donor-next-eligible').textContent = 'এখনই রক্ত দিতে পারবেন'; return; } const diff = Math.ceil((next.getTime()-now.getTime())/(24*60*60*1000)); $('donor-next-eligible').textContent = diff + ' দিন বাকি'; }

  async function saveDonorProfile(){ const id = state.currentUser.id; const payload = { name:$('donor-profile-name').value.trim(), altPhone:$('donor-profile-alt').value.trim(), gender:$('donor-profile-gender').value, bloodGroup:$('donor-profile-blood').value }; try{ await updateDoc(doc(db,'donors',id), payload); showToast('প্রোফাইল সেভ হয়েছে','success'); }catch(e){ console.error(e); showToast('সেভ ব্যর্থ','error'); } }

  async function updateLastDonation(){ const id = state.currentUser.id; const dateStr = $('donor-last-donation').value; if(!dateStr){ showToast('তারিখ দিন','error'); return; } const dt = new Date(dateStr); try{ await updateDoc(doc(db,'donors',id), { lastDonationDate: serverTimestamp(), lastDonationClient: dt.toISOString() }); showToast('আপডেট হয়েছে','success'); computeNextEligible(dt); }catch(e){ console.error(e); showToast('ফেইল','error'); } }

  // ---------- Blood Request & Smart Matching ----------
  async function handleBloodRequestSubmit(e){ e.preventDefault(); const payload = { patientDetails: $('req-patient-details').value.trim(), bloodGroup: $('req-blood-group').value, bagsNeeded: Number($('req-bags').value) || 1, hospital: $('req-hospital').value.trim(), contactNumber: sanitizePhone($('req-contact').value), address: { division: $('req-division').value, district: $('req-district').value, thana: $('req-thana').value, upazila: $('req-upazila').value }, status:'active', createdAt: serverTimestamp() }; try{ await addDoc(collection(db,'bloodRequests'), payload); showToast('অনুরোধ পাঠানো হয়েছে','success'); closeModal('modal-request'); await runSmartMatching(payload); }catch(e){ console.error('request',e); showToast('জমা ব্যর্থ','error'); } }

  async function runSmartMatching(requestObj){ const group = requestObj.bloodGroup; const district = requestObj.address.district; const division = requestObj.address.division; const donorsRef = collection(db,'donors'); let matched = []; try{ const q1 = query(donorsRef, where('bloodGroup','==',group), where('address.district','==', district)); const snap1 = await getDocs(q1); matched = snap1.docs.map(d=>({id:d.id,...d.data()})); if(!matched.length){ const q2 = query(donorsRef, where('bloodGroup','==',group), where('address.division','==', division)); const snap2 = await getDocs(q2); matched = snap2.docs.map(d=>({id:d.id,...d.data()})); } }catch(e){ console.error('matching',e); } renderMatchingResults(matched); }

  function renderMatchingResults(list){ const container = $('matching-container'); container.innerHTML=''; if(!list || !list.length){ const el=document.createElement('div'); el.className='small muted'; el.textContent = 'কোনো ডোনার পাওয়া যায়নি'; container.appendChild(el); return; } list.forEach(d=>{ const el=document.createElement('div'); el.className='match-item'; el.innerHTML = `<div><div style="font-weight:700">${escapeHtml(d.name||'—')}</div><div class="small">${escapeHtml(d.address?.division||'')} → ${escapeHtml(d.address?.district||'')}</div></div><div style="text-align:right"><div class="small">${escapeHtml(d.phone||'—')}</div><div class="small">${d.lastDonationClient? new Date(d.lastDonationClient).toLocaleDateString() : 'রেকর্ড নেই'}</div></div>`; container.appendChild(el); }); }

  async function handleQuickSearch(e){ e.preventDefault(); const group = $('search-blood').value; const division = $('search-division').value; if(!group && !division){ showToast('কিছু সিলেক্ট করুন','error'); return; } const donorsRef = collection(db,'donors'); try{ let q; if(group && division){ q = query(donorsRef, where('bloodGroup','==',group), where('address.division','==',division)); } else if(group){ q = query(donorsRef, where('bloodGroup','==',group)); } else { q = query(donorsRef, where('address.division','==',division)); } const snap = await getDocs(q); const results = snap.docs.map(d=>({id:d.id,...d.data()})); renderMatchingResults(results); showToast(results.length + ' matched','info'); }catch(e){ console.error('quicksearch',e); showToast('Search failed','error'); } }

  // ---------- Admin: Requests & Analytics ----------
  function subscribeToRequests(){ const ref = collection(db,'bloodRequests'); if(state.unsubscribe.requests) return; state.unsubscribe.requests = onSnapshot(query(ref, orderBy('createdAt','desc')), snap=>{ const c = $('admin-request-list'); c.innerHTML=''; if(snap.empty){ c.textContent = 'কোন অনুরোধ নেই'; return; } snap.docs.forEach(ds=>{ const r = {id:ds.id,...ds.data()}; const el = document.createElement('div'); el.className='small muted'; el.style.padding='8px'; el.style.borderBottom='1px solid rgba(0,0,0,0.04)'; el.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(r.patientDetails||'')}</strong><div class="small">${escapeHtml(r.bloodGroup||'')}</div></div><div><button data-delete-req="${r.id}" class="btn btn-ghost">Delete</button></div></div>`; c.appendChild(el); }); }, err=>{ console.error('req sub',err); }); }

  async function loadAdminDashboard(){ await refreshDonorCount(); subscribeToRequests(); await loadAnalytics(); }

  async function refreshDonorCount(){ try{ const donorsRef = collection(db,'donors'); let total=0; try{ const agg = await getCountFromServer(donorsRef); total = agg.data().count; }catch(err){ const snap = await getDocs(donorsRef); total = snap.size; } $('total-donors').textContent = total; }catch(e){ console.error(e); $('total-donors').textContent='--'; } }

  async function loadAnalytics(){ const days=14; const labels=[]; const regCounts=[]; const reqCounts=[]; for(let i=days-1;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); const key=d.toISOString().slice(0,10); labels.push(key); regCounts.push(0); reqCounts.push(0); } try{ const donorsSnap = await getDocs(collection(db,'donors')); donorsSnap.docs.forEach(d=>{ const data=d.data(); let created = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : null; if(!created && data.createdAt && typeof data.createdAt==='string') created = new Date(data.createdAt); if(created){ const key=created.toISOString().slice(0,10); const idx=labels.indexOf(key); if(idx>=0) regCounts[idx] += 1; } }); const reqSnap = await getDocs(collection(db,'bloodRequests')); reqSnap.docs.forEach(d=>{ const data=d.data(); let created = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : null; if(!created && data.createdAt && typeof data.createdAt==='string') created = new Date(data.createdAt); if(created){ const key=created.toISOString().slice(0,10); const idx=labels.indexOf(key); if(idx>=0) reqCounts[idx] += 1; } }); }catch(e){ console.error('analytics load', e); } try{ const ctx1 = $('chart-registrations').getContext('2d'); new Chart(ctx1,{ type:'line', data:{ labels, datasets:[{ label: LANG.current==='bn'?'নতুন রেজিস্ট্রেশন':'New Registrations', data: regCounts, fill:true, tension:0.3, borderColor:'rgba(214,40,40,0.9)', backgroundColor:'rgba(214,40,40,0.12)'}] }, options:{ responsive:true, plugins:{ legend:{display:false}} } }); const ctx2 = $('chart-requests').getContext('2d'); new Chart(ctx2,{ type:'bar', data:{ labels, datasets:[{ label: LANG.current==='bn'?'আসা অনুরোধ':'Requests', data: reqCounts, backgroundColor:'rgba(34,34,34,0.08)', borderColor:'rgba(214,40,40,0.9)', borderWidth:1 }] }, options:{ responsive:true, plugins:{ legend:{display:false}} } }); const donorsSnap2 = await getDocs(collection(db,'donors')); let active=0, inactive=0; donorsSnap2.docs.forEach(d=>{ const st = d.data().status || 'active'; if(st==='active') active++; else inactive++; }); const ctx3 = $('chart-active').getContext('2d'); new Chart(ctx3,{ type:'doughnut', data:{ labels: [LANG.current==='bn'?'Active':'Active', LANG.current==='bn'?'Inactive':'Inactive'], datasets:[{ data:[active,inactive], backgroundColor:['rgba(214,40,40,0.9)','rgba(128,128,128,0.3)'] }] }, options:{ responsive:true } }); }catch(e){ console.error('chart render', e); } }

  // ---------- Admin partner & config handlers ----------
  async function handlePartnerAdd(e){ e.preventDefault(); const name=$('admin-partner-name').value.trim(); const link=$('admin-partner-link').value.trim(); if(!name||!link){ showToast('নাম ও লিংক দিন','error'); return; } try{ await addDoc(collection(db,'partnerGroups'), { groupName:name, groupLink:link, createdAt: serverTimestamp() }); $('admin-partner-name').value=''; $('admin-partner-link').value=''; showToast('Partner added','success'); }catch(e){ console.error(e); showToast('Failed','error'); } }

  async function loadAdminConfig(){ try{ const d= await getDoc(doc(db,'appConfig','adminConfig')); if(d.exists()){ const data=d.data(); $('admin-config-whatsapp').value = data.whatsappNumber || ''; $('admin-config-bkash').value = data.bkashNumber || ''; $('admin-config-nagad').value = data.nagadNumber || ''; $('admin-config-password-webhook').value = data.passwordResetWebhook || ''; } }catch(e){ console.error(e);} }

  async function handleAdminConfigSave(e){ e.preventDefault(); const payload = { whatsappNumber:$('admin-config-whatsapp').value.trim(), bkashNumber:$('admin-config-bkash').value.trim(), nagadNumber:$('admin-config-nagad').value.trim(), passwordResetWebhook:$('admin-config-password-webhook').value.trim() }; try{ await setDoc(doc(db,'appConfig','adminConfig'), payload, { merge:true }); showToast('Settings saved','success'); }catch(e){ console.error(e); showToast('Failed','error'); } }

  // ---------- Modal & UI wiring ----------
  function openModal(id){ const m=$(id); if(m) m.classList.add('active'); }
  function closeModal(id){ const m=$(id); if(m) m.classList.remove('active'); }
  document.querySelectorAll('[data-close]').forEach(btn=> btn.addEventListener('click', (ev)=>{ const id = ev.target.closest('[data-close]').dataset.close; closeModal(id); }));

  function wireUI(){
    $('open-register').addEventListener('click', ()=>{ $('view-login').classList.add('hidden'); $('view-register').classList.remove('hidden'); });
    $('reg-back').addEventListener('click', ()=>{ $('view-register').classList.add('hidden'); $('view-login').classList.remove('hidden'); });
    $('register-form').addEventListener('submit', handleRegister);
    $('login-form').addEventListener('submit', handleLogin);
    $('quick-search-form').addEventListener('submit', handleQuickSearch);
    $('open-blood-request').addEventListener('click', ()=> openModal('modal-request'));
    $('blood-request-form').addEventListener('submit', handleBloodRequestSubmit);
    $('save-profile').addEventListener('click', saveDonorProfile);
    $('update-donation').addEventListener('click', updateLastDonation);
    $('btn-logout').addEventListener('click', handleSignOut);
    $('admin-logout').addEventListener('click', handleSignOut);
    $('admin-partner-form').addEventListener('submit', handlePartnerAdd);
    $('admin-config-form').addEventListener('submit', handleAdminConfigSave);

    // modal backdrop click to close
    document.querySelectorAll('.modal-backdrop').forEach(mb=>{ mb.addEventListener('click', (ev)=>{ if(ev.target === mb) mb.classList.remove('active'); }); });

    // delete partner delegation
    document.body.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('[data-delete]');
      if(btn){ const id = btn.dataset.delete; if(!confirm('Are you sure?')) return; try{ await deleteDoc(doc(db,'partnerGroups',id)); showToast('Deleted','success'); }catch(e){ console.error(e); showToast('Failed','error'); } }
      const delReq = ev.target.closest('[data-delete-req]');
      if(delReq){ const id = delReq.dataset.deleteReq; if(!confirm('Delete request?')) return; try{ await deleteDoc(doc(db,'bloodRequests',id)); showToast('Deleted','success'); }catch(e){ console.error(e); showToast('Failed','error'); } }
    });
  }

  // ---------- Initialization ----------
  (async function init(){
    applyI18n();
    setupStaticSelects();
    loadDivisionSelects();
    bindLocation('reg');
    bindLocation('req');
    bindLocation('search');
    wireUI();
    watchPartnerGroups();
    watchNotice();
    await restoreSession();
    $('footer-year').textContent = new Date().getFullYear();
  })();

  </script>
</body>
</html>
